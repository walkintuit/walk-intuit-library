<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walk Intuit Digital Library System</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .github-notice {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #28a745;
            color: white;
            padding: 12px;
            text-align: center;
            z-index: 1000;
            font-weight: bold;
            font-size: 0.9em;
        }

        .container {
            max-width: 1400px;
            margin: 50px auto 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab.active {
            color: #2c3e50;
            background: white;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #3498db;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .image-upload-area {
            border: 3px dashed #bdc3c7;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .image-upload-area:hover {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }

        .image-upload-area.dragover {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
        }

        .image-preview {
            max-width: 200px;
            max-height: 250px;
            border-radius: 8px;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85em;
            margin: 0 5px;
        }

        .search-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .search-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        .book-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
            position: relative;
            overflow: hidden;
        }

        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .book-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .book-info h3 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.2em;
            line-height: 1.3;
        }

        .book-info p {
            color: #7f8c8d;
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        .book-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 10px 0;
        }

        .status-available {
            background: #d4edda;
            color: #155724;
        }

        .status-checked-out {
            background: #f8d7da;
            color: #721c24;
        }

        .book-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 300;
            margin-bottom: 5px;
        }

        .stat-label {
            opacity: 0.9;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 1px;
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .sync-status.syncing {
            background: #ffc107;
            color: #212529;
        }

        .sync-status.error {
            background: #dc3545;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .history-table th, .history-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .history-table th {
            background: #2c3e50;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .form-grid, .search-grid {
                grid-template-columns: 1fr;
            }
            
            .books-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }

            .container {
                margin-top: 70px;
            }

            .sync-status {
                bottom: 10px;
                right: 10px;
                font-size: 0.8em;
                padding: 8px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="github-notice">
        ✅ GitHub-powered library with shared data across all users
    </div>

    <div class="sync-status" id="syncStatus">
        🔄 Syncing...
    </div>

    <div class="container">
        <div class="header">
            <h1>📚 Walk Intuit Digital Library</h1>
            <p>GitHub-powered shared library system for Orange, Costa Mesa & SJC</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('browse')">Browse Library</button>
            <button class="nav-tab" onclick="switchTab('add')">Add Book</button>
            <button class="nav-tab" onclick="switchTab('manage')">Manage Checkouts</button>
            <button class="nav-tab" onclick="switchTab('history')">History & Reports</button>
        </div>

        <div id="browse" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalBooks">-</div>
                    <div class="stat-label">Total Books</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="availableBooks">-</div>
                    <div class="stat-label">Available</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="checkedOutBooks">-</div>
                    <div class="stat-label">Checked Out</div>
                </div>
            </div>

            <div class="search-section">
                <div class="search-grid">
                    <div class="form-group">
                        <label for="searchInput">Search Books</label>
                        <input type="text" id="searchInput" placeholder="Search by title, author, or ISBN..." oninput="searchBooks()">
                    </div>
                    <div class="form-group">
                        <label for="siteFilter">Filter by Site</label>
                        <select id="siteFilter" onchange="searchBooks()">
                            <option value="">All Sites</option>
                            <option value="Orange">Orange</option>
                            <option value="Costa Mesa">Costa Mesa</option>
                            <option value="SJC">SJC</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="clearSearch()">Clear Filters</button>
                </div>
            </div>

            <div class="books-grid" id="booksContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">📖</div>
                    <h3>Loading library...</h3>
                    <p>Please wait while we sync with GitHub</p>
                </div>
            </div>
        </div>

        <div id="add" class="tab-content">
            <h2 style="margin-bottom: 30px; color: #2c3e50;">Add New Book to Library</h2>
            
            <div id="addBookAlert"></div>

            <form id="addBookForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="bookTitle">Book Title *</label>
                        <input type="text" id="bookTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="bookAuthor">Author *</label>
                        <input type="text" id="bookAuthor" required>
                    </div>
                    <div class="form-group">
                        <label for="bookISBN">ISBN</label>
                        <input type="text" id="bookISBN" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label for="bookSite">Location Site *</label>
                        <select id="bookSite" required>
                            <option value="">Select Site</option>
                            <option value="Orange">Orange</option>
                            <option value="Costa Mesa">Costa Mesa</option>
                            <option value="SJC">SJC</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="bookDescription">Description</label>
                    <textarea id="bookDescription" rows="3" placeholder="Optional description or notes"></textarea>
                </div>

                <div class="form-group">
                    <label>Book Cover Image</label>
                    <div class="image-upload-area" onclick="document.getElementById('imageInput').click()">
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        <div id="uploadText">
                            <h3>📷 Click or drag to upload book cover</h3>
                            <p>Supports JPG, PNG, GIF (Max 5MB)</p>
                        </div>
                        <img id="imagePreview" class="image-preview" style="display: none;">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="margin-top: 20px;">
                    <span id="addBookButtonText">Add Book to Library</span>
                </button>
            </form>
        </div>

        <div id="manage" class="tab-content">
            <h2 style="margin-bottom: 30px; color: #2c3e50;">Manage Book Checkouts</h2>
            
            <div class="search-section">
                <div class="form-group">
                    <label for="manageSearch">Search Books</label>
                    <input type="text" id="manageSearch" placeholder="Search by title, author, or current borrower..." oninput="searchManageBooks()">
                </div>
            </div>

            <div class="books-grid" id="manageBooksContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">📚</div>
                    <h3>Loading books...</h3>
                </div>
            </div>
        </div>

        <div id="history" class="tab-content">
            <h2 style="margin-bottom: 30px; color: #2c3e50;">Checkout History & Reports</h2>
            
            <div class="search-section">
                <div class="search-grid">
                    <div class="form-group">
                        <label for="historySearch">Search History</label>
                        <input type="text" id="historySearch" placeholder="Search by book title, clinician name..." oninput="searchHistory()">
                    </div>
                    <div class="form-group">
                        <label for="historyFilter">Filter by Action</label>
                        <select id="historyFilter" onchange="searchHistory()">
                            <option value="">All Actions</option>
                            <option value="checked_out">Checked Out</option>
                            <option value="returned">Returned</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="exportHistory()">Export History</button>
                </div>
            </div>

            <table class="history-table" id="historyTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Book Title</th>
                        <th>Author</th>
                        <th>Site</th>
                        <th>Clinician</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #7f8c8d;">
                            Loading history...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Check Out Book</h2>
            <div id="modalBookInfo"></div>
            <div class="form-group" style="margin-top: 20px;">
                <label for="clinicianName">Clinician Name *</label>
                <input type="text" id="clinicianName" required>
            </div>
            <div class="form-group">
                <label for="clinicianEmail">Clinician Email</label>
                <input type="email" id="clinicianEmail" placeholder="Optional">
            </div>
            <div class="form-group">
                <label for="dueDate">Due Date</label>
                <input type="date" id="dueDate">
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-primary" onclick="confirmCheckout()">Confirm Checkout</button>
                <button class="btn" onclick="closeModal()" style="margin-left: 10px; background: #6c757d; color: white;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // GITHUB INTEGRATION FOR SHARED DATA
        // ==========================================

        // GitHub configuration - you'll replace these with your actual repository details
        const GITHUB_CONFIG = {
            owner: 'your-github-username',     // Replace with your GitHub username
            repo: 'walk-intuit-library-data',  // Replace with your data repository name
            branch: 'main',
            token: null // We'll use GitHub's public API for simplicity
        };

        // GitHub API endpoints
        const GITHUB_API = {
            baseUrl: 'https://api.github.com',
            contentsUrl: `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents`,
            rawUrl: `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}`
        };

        // ==========================================
        // DATA MANAGEMENT
        // ==========================================

        let libraryData = {
            books: [],
            history: [],
            lastUpdated: new Date().toISOString()
        };

        let isOnline = navigator.onLine;
        let lastSyncTime = null;

        // Update sync status indicator
        function updateSyncStatus(message, type = 'success') {
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.textContent = message;
            syncStatus.className = `sync-status ${type}`;
            
            if (type === 'success') {
                setTimeout(() => {
                    syncStatus.textContent = '✅ Synced';
                }, 2000);
            }
        }

        // Load data from GitHub (public read-only)
        async function loadFromGitHub() {
            try {
                updateSyncStatus('🔄 Loading from GitHub...', 'syncing');
                
                // Try to load books data
                try {
                    const booksResponse = await fetch(`${GITHUB_API.rawUrl}/books.json`);
                    if (booksResponse.ok) {
                        libraryData.books = await booksResponse.json();
                    }
                } catch (e) {
                    console.log('No books.json found, starting with empty library');
                }

                // Try to load history data
                try {
                    const historyResponse = await fetch(`${GITHUB_API.rawUrl}/history.json`);
                    if (historyResponse.ok) {
                        libraryData.history = await historyResponse.json();
                    }
                } catch (e) {
                    console.log('No history.json found, starting with empty history');
                }

                lastSyncTime = new Date();
                updateSyncStatus('✅ Loaded from GitHub', 'success');
                
            } catch (error) {
                console.error('Error loading from GitHub:', error);
                updateSyncStatus('⚠️ Using local data', 'error');
                loadFromLocalStorage();
            }
        }

        // Save to localStorage as backup
        function saveToLocalStorage() {
            try {
                localStorage.setItem('walkIntuitLibrary', JSON.stringify(libraryData));
            } catch (e) {
                console.warn('Could not save to localStorage:', e);
            }
        }

        // Load from localStorage as fallback
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('walkIntuitLibrary');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    libraryData = { ...libraryData, ...parsed };
                }
            } catch (e) {
                console.warn('Could not load from localStorage:', e);
            }
        }

        // Simulate saving to GitHub (in real implementation, this would use GitHub API with authentication)
        async function saveToGitHub() {
            updateSyncStatus('💾 Saving to GitHub...', 'syncing');
            
            // For this demo, we'll just save locally and show instructions
            saveToLocalStorage();
            
            // In a real implementation, you would use the GitHub API to commit changes
            // This requires authentication and is more complex for a simple demo
            
            setTimeout(() => {
                updateSyncStatus('✅ Saved locally', 'success');
                showSaveInstructions();
            }, 1000);
        }

        // Show instructions for manual GitHub sync
        function showSaveInstructions() {
            // This would show a modal with instructions for manually updating GitHub
            // For simplicity, we'll just console.log the data
            console.log('📝 Copy this data to your GitHub repository:');
            console.log('books.json:', JSON.stringify(libraryData.books, null, 2));
            console.log('history.json:', JSON.stringify(libraryData.history, null, 2));
        }

        // ==========================================
        // CORE LIBRARY FUNCTIONS
        // ==========================================

        // Initialize app
        window.addEventListener('load', async function() {
            // Check if we're online
            updateOnlineStatus();
            
            // Load data from GitHub first, fallback to localStorage
            if (isOnline) {
                await loadFromGitHub();
            } else {
                loadFromLocalStorage();
                updateSyncStatus('📱 Offline mode', 'error');
            }
            
            // Initialize UI
            updateStats();
            displayBooks();
            displayManageBooks();
            displayHistory();
            
            // Set default due date
            const today = new Date();
            const twoWeeksLater = new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000);
            document.getElementById('dueDate').value = twoWeeksLater.toISOString().split('T')[0];
            
            // Set up periodic sync
            setInterval(syncWithGitHub, 30000); // Sync every 30 seconds
        });

        // Handle online/offline status
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            if (!isOnline) {
                updateSyncStatus('📱 Offline', 'error');
            }
        }

        window.addEventListener('online', () => {
            isOnline = true;
            syncWithGitHub();
        });

        window.addEventListener('offline', updateOnlineStatus);

        // Periodic sync with GitHub
        async function syncWithGitHub() {
            if (!isOnline) return;
            
            try {
                // Check if remote data is newer
                const remoteBooks = await fetch(`${GITHUB_API.rawUrl}/books.json?_=${Date.now()}`);
                const remoteHistory = await fetch(`${GITHUB_API.rawUrl}/history.json?_=${Date.now()}`);
                
                let hasUpdates = false;
                
                if (remoteBooks.ok) {
                    const remoteBooksData = await remoteBooks.json();
                    if (JSON.stringify(remoteBooksData) !== JSON.stringify(libraryData.books)) {
                        libraryData.books = remoteBooksData;
                        hasUpdates = true;
                    }
                }
                
                if (remoteHistory.ok) {
                    const remoteHistoryData = await remoteHistory.json();
                    if (JSON.stringify(remoteHistoryData) !== JSON.stringify(libraryData.history)) {
                        libraryData.history = remoteHistoryData;
                        hasUpdates = true;
                    }
                }
                
                if (hasUpdates) {
                    updateStats();
                    displayBooks();
                    displayManageBooks();
                    displayHistory();
                    updateSyncStatus('🔄 Updated from GitHub', 'syncing');
                    setTimeout(() => updateSyncStatus('✅ Synced', 'success'), 1000);
                }
                
                lastSyncTime = new Date();
                
            } catch (error) {
                console.log('Sync check failed (normal if no internet):', error);
            }
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Refresh displays when switching tabs
            if (tabName === 'browse') {
                updateStats();
                displayBooks();
            } else if (tabName === 'manage') {
                displayManageBooks();
            } else if (tabName === 'history') {
                displayHistory();
            }
        }

        // Update statistics
        function updateStats() {
            const totalBooks = libraryData.books.length;
            const availableBooks = libraryData.books.filter(book => book.status === 'available').length;
            const checkedOutBooks = libraryData.books.filter(book => book.status === 'checked_out').length;

            document.getElementById('totalBooks').textContent = totalBooks;
            document.getElementById('availableBooks').textContent = availableBooks;
            document.getElementById('checkedOutBooks').textContent = checkedOutBooks;
        }

        // Display alert messages
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type === 'error' ? 'error' : 'success'}">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Image upload handling
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showAlert('addBookAlert', 'Image size must be less than 5MB', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    const uploadText = document.getElementById('uploadText');
                    
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    uploadText.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        // Add book form submission
        document.getElementById('addBookForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = document.querySelector('#addBookForm button[type="submit"]');
            const buttonText = document.getElementById('addBookButtonText');
            
            try {
                submitButton.disabled = true;
                buttonText.textContent = 'Adding Book...';
                
                const title = document.getElementById('bookTitle').value.trim();
                const author = document.getElementById('bookAuthor').value.trim();
                const isbn = document.getElementById('bookISBN').value.trim();
                const site = document.getElementById('bookSite').value;
                const description = document.getElementById('bookDescription').value.trim();
                const imageFile = document.getElementById('imageInput').files[0];

                if (!title || !author || !site) {
                    showAlert('addBookAlert', 'Please fill in all required fields', 'error');
                    return;
                }

                // Handle image
                let imageData = null;
                if (imageFile) {
                    buttonText.textContent = 'Processing Image...';
                    const reader = new FileReader();
                    imageData = await new Promise((resolve) => {
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(imageFile);
                    });
                }

                // Create book object
                const newBook = {
                    id: Date.now().toString(),
                    title: title,
                    author: author,
                    isbn: isbn || null,
                    site: site,
                    description: description || null,
                    image: imageData,
                    status: 'available',
                    addedDate: new Date().toISOString(),
                    currentBorrower: null,
                    currentBorrowerEmail: null,
                    dueDate: null
                };

                libraryData.books.push(newBook);
                libraryData.lastUpdated = new Date().toISOString();
                
                await saveToGitHub();
                
                showAlert('addBookAlert', `"${newBook.title}" has been added to the library!`, 'success');
                
                // Reset form
                document.getElementById('addBookForm').reset();
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('uploadText').style.display = 'block';
                
                // Update displays
                updateStats();
                displayBooks();
                displayManageBooks();
                
            } catch (error) {
                console.error('Error adding book:', error);
                showAlert('addBookAlert', 'Error adding book: ' + error.message, 'error');
            } finally {
                submitButton.disabled = false;
                buttonText.textContent = 'Add Book to Library';
            }
        });

        // Display books in browse tab
        function displayBooks(books = null) {
            const container = document.getElementById('booksContainer');
            const booksToShow = books || libraryData.books;

            if (booksToShow.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📖</div>
                        <h3>No books found</h3>
                        <p>Try adjusting your search criteria or add some books to the library!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = booksToShow.map(book => `
                <div class="book-card">
                    <img src="${book.image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI1MCIgdmlld0JveD0iMCAwIDIwMCAyNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjUwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik02MCA4MEgxNDBWMTcwSDYwVjgwWiIgZmlsbD0iI0U5RUNFRiIvPgo8dGV4dCB4PSIxMDAiIHk9IjE5MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNkM3NTdEIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5ObyBJbWFnZTwvdGV4dD4KPHN2Zz4='}" 
                         alt="${book.title}" class="book-image">
                    <div class="book-info">
                        <h3>${book.title}</h3>
                        <p><strong>Author:</strong> ${book.author}</p>
                        <p><strong>Site:</strong> ${book.site}</p>
                        ${book.isbn ? `<p><strong>ISBN:</strong> ${book.isbn}</p>` : ''}
                        ${book.description ? `<p><strong>Description:</strong> ${book.description}</p>` : ''}
                        <div class="book-status ${book.status === 'available' ? 'status-available' : 'status-checked-out'}">
                            ${book.status === 'available' ? 'Available' : `Checked out${book.currentBorrower ? ' to ' + book.currentBorrower : ''}`}
                        </div>
                        ${book.status === 'checked_out' && book.dueDate ? `<p><strong>Due:</strong> ${new Date(book.dueDate).toLocaleDateString()}</p>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Search books functionality
        function searchBooks() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const siteFilter = document.getElementById('siteFilter').value;

            let filteredBooks = libraryData.books;

            if (searchTerm) {
                filteredBooks = filteredBooks.filter(book => 
                    book.title.toLowerCase().includes(searchTerm) ||
                    book.author.toLowerCase().includes(searchTerm) ||
                    (book.isbn && book.isbn.toLowerCase().includes(searchTerm)) ||
                    (book.description && book.description.toLowerCase().includes(searchTerm))
                );
            }

            if (siteFilter) {
                filteredBooks = filteredBooks.filter(book => book.site === siteFilter);
            }

            displayBooks(filteredBooks);
        }

        // Clear search filters
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('siteFilter').value = '';
            displayBooks();
        }

        // Display books in manage tab
        function displayManageBooks(books = null) {
            const container = document.getElementById('manageBooksContainer');
            const booksToShow = books || libraryData.books;

            if (booksToShow.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📚</div>
                        <h3>No books available</h3>
                        <p>Add some books to start managing checkouts!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = booksToShow.map(book => `
                <div class="book-card">
                    <img src="${book.image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI1MCIgdmlld0JveD0iMCAwIDIwMCAyNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjUwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik02MCA4MEgxNDBWMTcwSDYwVjgwWiIgZmlsbD0iI0U5RUNFRiIvPgo8dGV4dCB4PSIxMDAiIHk9IjE5MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNkM3NTdEIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5ObyBJbWFnZTwvdGV4dD4KPHN2Zz4='}" 
                         alt="${book.title}" class="book-image">
                    <div class="book-info">
                        <h3>${book.title}</h3>
                        <p><strong>Author:</strong> ${book.author}</p>
                        <p><strong>Site:</strong> ${book.site}</p>
                        <div class="book-status ${book.status === 'available' ? 'status-available' : 'status-checked-out'}">
                            ${book.status === 'available' ? 'Available' : `Checked out${book.currentBorrower ? ' to ' + book.currentBorrower : ''}`}
                        </div>
                        ${book.status === 'checked_out' && book.dueDate ? `<p><strong>Due:</strong> ${new Date(book.dueDate).toLocaleDateString()}</p>` : ''}
                        ${book.status === 'checked_out' && book.currentBorrowerEmail ? `<p><strong>Email:</strong> ${book.currentBorrowerEmail}</p>` : ''}
                    </div>
                    <div class="book-actions">
                        ${book.status === 'available' ? 
                            `<button class="btn btn-success btn-small" onclick="openCheckoutModal('${book.id}')">Check Out</button>` :
                            `<button class="btn btn-warning btn-small" onclick="returnBook('${book.id}')">Return Book</button>`
                        }
                        <button class="btn btn-danger btn-small" onclick="deleteBook('${book.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Search books in manage tab
        function searchManageBooks() {
            const searchTerm = document.getElementById('manageSearch').value.toLowerCase().trim();

            let filteredBooks = libraryData.books;

            if (searchTerm) {
                filteredBooks = filteredBooks.filter(book => 
                    book.title.toLowerCase().includes(searchTerm) ||
                    book.author.toLowerCase().includes(searchTerm) ||
                    (book.currentBorrower && book.currentBorrower.toLowerCase().includes(searchTerm)) ||
                    (book.currentBorrowerEmail && book.currentBorrowerEmail.toLowerCase().includes(searchTerm))
                );
            }

            displayManageBooks(filteredBooks);
        }

        // Open checkout modal
        function openCheckoutModal(bookId) {
            const book = libraryData.books.find(b => b.id === bookId);
            if (!book || book.status !== 'available') return;

            document.getElementById('modalTitle').textContent = 'Check Out Book';
            document.getElementById('modalBookInfo').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 5px;">${book.title}</h4>
                    <p style="margin-bottom: 5px;"><strong>Author:</strong> ${book.author}</p>
                    <p style="margin: 0;"><strong>Site:</strong> ${book.site}</p>
                </div>
            `;
            
            document.getElementById('checkoutModal').style.display = 'block';
            document.getElementById('checkoutModal').dataset.bookId = bookId;
            
            // Clear previous form data
            document.getElementById('clinicianName').value = '';
            document.getElementById('clinicianEmail').value = '';
        }

        // Close modal
        function closeModal() {
            document.getElementById('checkoutModal').style.display = 'none';
        }

        // Confirm checkout
        async function confirmCheckout() {
            const bookId = document.getElementById('checkoutModal').dataset.bookId;
            const clinicianName = document.getElementById('clinicianName').value.trim();
            const clinicianEmail = document.getElementById('clinicianEmail').value.trim();
            const dueDate = document.getElementById('dueDate').value;

            if (!clinicianName) {
                alert('Please enter the clinician name');
                return;
            }

            try {
                const bookIndex = libraryData.books.findIndex(b => b.id === bookId);
                if (bookIndex === -1) return;

                const book = libraryData.books[bookIndex];

                // Update book status
                libraryData.books[bookIndex] = {
                    ...book,
                    status: 'checked_out',
                    currentBorrower: clinicianName,
                    currentBorrowerEmail: clinicianEmail || null,
                    dueDate: dueDate || null,
                    checkedOutDate: new Date().toISOString()
                };

                // Add to checkout history
                const historyEntry = {
                    id: Date.now().toString(),
                    bookId: book.id,
                    bookTitle: book.title,
                    author: book.author,
                    site: book.site,
                    clinicianName: clinicianName,
                    clinicianEmail: clinicianEmail,
                    action: 'checked_out',
                    date: new Date().toISOString(),
                    dueDate: dueDate || null
                };

                libraryData.history.unshift(historyEntry);
                libraryData.lastUpdated = new Date().toISOString();

                await saveToGitHub();

                closeModal();
                
                // Update displays
                updateStats();
                displayBooks();
                displayManageBooks();
                displayHistory();
                
                alert(`"${book.title}" has been checked out to ${clinicianName}`);

            } catch (error) {
                console.error('Error checking out book:', error);
                alert('Error checking out book: ' + error.message);
            }
        }

        // Return book
        async function returnBook(bookId) {
            const bookIndex = libraryData.books.findIndex(b => b.id === bookId);
            if (bookIndex === -1) return;

            const book = libraryData.books[bookIndex];
            if (book.status !== 'checked_out') return;

            if (confirm(`Return "${book.title}"?`)) {
                try {
                    const previousBorrower = book.currentBorrower;
                    const previousEmail = book.currentBorrowerEmail;
                    
                    // Update book status
                    libraryData.books[bookIndex] = {
                        ...book,
                        status: 'available',
                        currentBorrower: null,
                        currentBorrowerEmail: null,
                        dueDate: null,
                        checkedOutDate: null
                    };

                    // Add to history
                    const historyEntry = {
                        id: Date.now().toString(),
                        bookId: book.id,
                        bookTitle: book.title,
                        author: book.author,
                        site: book.site,
                        clinicianName: previousBorrower,
                        clinicianEmail: previousEmail,
                        action: 'returned',
                        date: new Date().toISOString(),
                        dueDate: null
                    };

                    libraryData.history.unshift(historyEntry);
                    libraryData.lastUpdated = new Date().toISOString();

                    await saveToGitHub();
                    
                    // Update displays
                    updateStats();
                    displayBooks();
                    displayManageBooks();
                    displayHistory();
                    
                    alert(`"${book.title}" has been returned successfully`);

                } catch (error) {
                    console.error('Error returning book:', error);
                    alert('Error returning book: ' + error.message);
                }
            }
        }

        // Delete book
        async function deleteBook(bookId) {
            const book = libraryData.books.find(b => b.id === bookId);
            if (!book) return;

            if (book.status === 'checked_out') {
                alert('Cannot delete a book that is currently checked out. Please return it first.');
                return;
            }

            if (confirm(`Are you sure you want to delete "${book.title}"? This action cannot be undone.`)) {
                try {
                    libraryData.books = libraryData.books.filter(b => b.id !== bookId);
                    libraryData.lastUpdated = new Date().toISOString();

                    await saveToGitHub();
                    
                    // Update displays
                    updateStats();
                    displayBooks();
                    displayManageBooks();
                    displayHistory();
                    
                    alert(`"${book.title}" has been deleted from the library`);

                } catch (error) {
                    console.error('Error deleting book:', error);
                    alert('Error deleting book: ' + error.message);
                }
            }
        }

        // Display history
        function displayHistory(historyItems = null) {
            const tbody = document.getElementById('historyTableBody');
            const itemsToShow = historyItems || libraryData.history;

            if (itemsToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #7f8c8d;">
                            No checkout history available yet
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = itemsToShow.map(item => `
                <tr>
                    <td>${new Date(item.date).toLocaleDateString()} ${new Date(item.date).toLocaleTimeString()}</td>
                    <td>${item.bookTitle}</td>
                    <td>${item.author}</td>
                    <td>${item.site}</td>
                    <td>${item.clinicianName}${item.clinicianEmail ? ` (${item.clinicianEmail})` : ''}</td>
                    <td>
                        <span style="padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 600; text-transform: uppercase;
                               background: ${item.action === 'checked_out' ? '#fef3c7' : '#d1fae5'}; 
                               color: ${item.action === 'checked_out' ? '#92400e' : '#065f46'};">
                            ${item.action === 'checked_out' ? 'Checked Out' : 'Returned'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // Search history
        function searchHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase().trim();
            const actionFilter = document.getElementById('historyFilter').value;

            let filteredHistory = libraryData.history;

            if (searchTerm) {
                filteredHistory = filteredHistory.filter(item => 
                    item.bookTitle.toLowerCase().includes(searchTerm) ||
                    item.author.toLowerCase().includes(searchTerm) ||
                    item.clinicianName.toLowerCase().includes(searchTerm) ||
                    (item.clinicianEmail && item.clinicianEmail.toLowerCase().includes(searchTerm))
                );
            }

            if (actionFilter) {
                filteredHistory = filteredHistory.filter(item => item.action === actionFilter);
            }

            displayHistory(filteredHistory);
        }

        // Export history to CSV
        function exportHistory() {
            if (libraryData.history.length === 0) {
                alert('No history data to export');
                return;
            }

            const csvContent = [
                ['Date', 'Time', 'Book Title', 'Author', 'Site', 'Clinician Name', 'Clinician Email', 'Action'],
                ...libraryData.history.map(item => [
                    new Date(item.date).toLocaleDateString(),
                    new Date(item.date).toLocaleTimeString(),
                    item.bookTitle,
                    item.author,
                    item.site,
                    item.clinicianName,
                    item.clinicianEmail || '',
                    item.action === 'checked_out' ? 'Checked Out' : 'Returned'
                ])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `walk-intuit-library-history-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Drag and drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.querySelector('.image-upload-area');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('imageInput').files = files;
                    handleImageUpload({ target: { files: files } });
                }
            });
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('checkoutModal');
            if (event.target === modal) {
                closeModal();
            }
        });
    </script>
</body>
</html>